---
title: Real-Time and Performance Requirements
description: Timing constraints, determinism, and resource usage

requirements:
  
  - id: "PERF-001"
    title: "FOC Control Loop Executes at 10 kHz"
    rationale: "10 kHz update rate provides responsive current control and low torque ripple"
    content:
      given: "PWM timer is running"
      when: "PWM cycle completes (every 100 microseconds)"
      then: "FOC control interrupt is triggered and control loop executes"
  - id: "PERF-002"
    title: "FOC Loop Execution Time Maximum 20 Microseconds"
    rationale: "20 µs budget is 20% of PWM period, leaving 80% for other tasks"
    content:
      given: "FOC ISR is executing"
      when: "Control algorithm completes (ADC read, Park, PI, inverse Park, SVM)"
      then: "Total execution time is less than 20 microseconds"
  - id: "PERF-003"
    title: "FOC Loop Jitter Maximum ±2 Microseconds"
    rationale: "Low jitter ensures stable, predictable control behavior"
    content:
      given: "FOC control loop runs multiple cycles"
      when: "Cycle-to-cycle timing is measured"
      then: "Timing variation is within ±2 microseconds (±2% of 100 µs period)"
  - id: "PERF-004"
    title: "ADC Sampling within FOC Loop"
    rationale: "Current feedback must be obtained synchronously with PWM for stable control"
    content:
      given: "FOC loop ISR starts"
      when: "Control cycle begins"
      then: "Phase currents are sampled via ADC within 2 microseconds"
  
  - id: "PERF-010"
    title: "Velocity Control Loop Executes at 1 kHz"
    rationale: "1 kHz outer loop provides stable speed regulation without excessive overhead"
    content:
      given: "System is running"
      when: "1 millisecond timer interval elapses"
      then: "Velocity control loop executes (runs 10x per FOC cycle)"
  - id: "PERF-011"
    title: "Velocity Loop Execution Time Maximum 100 Microseconds"
    rationale: "100 µs leaves adequate time for other tasks within 1 ms interval"
    content:
      given: "Velocity control loop ISR executes"
      when: "Speed calculation and PI controller update complete"
      then: "Total execution time is less than 100 microseconds"
  - id: "PERF-012"
    title: "Velocity Loop Jitter Maximum ±50 Microseconds"
    rationale: "Speed control is less time-critical than current control"
    content:
      given: "Velocity loop timing is monitored"
      when: "Multiple control cycles are measured"
      then: "Cycle-to-cycle timing variation is within ±50 microseconds"
  
  - id: "PERF-020"
    title: "No Missed Control Loop Deadlines"
    rationale: "Every control cycle must complete before next period; failures indicate firmware bug"
    content:
      given: "FOC control loop is running"
      when: "Control cycle executes"
      then: "Control loop always completes within 100 microsecond deadline"
  - id: "PERF-021"
    title: "Interrupt Latency Less Than 1 Microsecond"
    rationale: "Fast interrupt response ensures timely fault detection"
    content:
      given: "Interrupt assertion occurs"
      when: "FOC control interrupt is generated"
      then: "ISR begins execution within 1 microsecond (typical ARM Cortex-M)"
  - id: "PERF-022"
    title: "No Blocking Waits in Control Paths"
    rationale: "Blocking calls would violate deterministic timing constraints"
    content:
      given: "Control loop ISR is executing"
      when: "Any operation occurs"
      then: "No spin-locks, semaphores, or I/O waits are used in FOC or velocity loops"
  
  - id: "PERF-030"
    title: "Zero Dynamic Memory Allocation"
    rationale: "Heap allocation is non-deterministic and unpredictable for real-time systems"
    content:
      given: "System is initialized"
      when: "Control loops are running"
      then: "No malloc, new, free, or delete operations occur in real-time code paths"
  - id: "PERF-031"
    title: "Bounded Containers Only"
    rationale: "Bounded containers have compile-time fixed size, enabling determinism"
    content:
      given: "Data structures are allocated"
      when: "Buffers or containers are created"
      then: "infra::BoundedVector, infra::BoundedString, or similar are used (never std::vector or std::string)"
  - id: "PERF-032"
    title: "Maximum Stack Usage 512 Bytes per ISR"
    rationale: "Limited stack prevents stack overflow in nested interrupt scenarios"
    content:
      given: "ISR function calls occur"
      when: "Stack depth is measured"
      then: "Maximum stack frame for any ISR is less than 512 bytes"
  - id: "PERF-033"
    title: "No Recursion in ISR Context"
    rationale: "Recursion makes stack usage unpredictable"
    content:
      given: "Interrupt service routine executes"
      when: "Function call chain occurs"
      then: "No recursive function calls are allowed in FOC loop or velocity loop"
  - id: "PERF-034"
    title: "Total Data RAM Under 8 KB"
    rationale: "Resource-constrained embedded systems have limited RAM"
    content:
      given: "System initializes"
      when: "All static variables and buffers are allocated"
      then: "Total RAM usage is less than 8 kilobytes"
  - id: "PERF-035"
    title: "Program Flash Under 40 KB"
    rationale: "Embedded systems often have flash constraints"
    content:
      given: "Firmware is compiled"
      when: "All code and constants are linked"
      then: "Total program size is less than 40 kilobytes"
  
  - id: "PERF-040"
    title: "FOC Interrupt Has Highest Priority"
    rationale: "Current control is most time-critical function"
    content:
      given: "Interrupt priorities are configured"
      when: "System initializes"
      then: "FOC/PWM interrupt is assigned highest NVIC priority (typically 0 on ARM)"
  - id: "PERF-041"
    title: "CAN Interrupt Can Be Preempted by FOC"
    rationale: "CAN communication is less time-critical than motor control"
    content:
      given: "CAN interrupt is executing"
      when: "FOC interrupt is triggered"
      then: "FOC interrupt preempts CAN interrupt; CAN resumes afterward"
  - id: "PERF-042"
    title: "Maximum 2 Interrupt Nesting Levels"
    rationale: "Deep nesting increases stack usage and complexity"
    content:
      given: "Multiple interrupts are active"
      when: "Interrupt nesting occurs"
      then: "Maximum nesting depth is 2 levels (e.g., FOC interrupts CAN which was running task)"
  
  - id: "PERF-050"
    title: "Execute Profiling Instrumentation"
    rationale: "Timing data enables validation of real-time constraints"
    content:
      given: "Debug instrumentation is enabled"
      when: "Control loop executes"
      then: "GPIO pins toggle at ISR entry/exit for oscilloscope measurement"
  - id: "PERF-051"
    title: "Cycle Counter Available for Profiling"
    rationale: "Precise cycle counting enables detailed timing analysis"
    content:
      given: "Profiling is enabled"
      when: "Timing measurement is needed"
      then: "System can read ARM Cortex-M cycle counter (DWT_CYCCNT) for precision timing"
  
  - id: "PERF-060"
    title: "Extended Stress Testing"
    rationale: "Long-duration tests reveal intermittent timing issues and edge cases"
    content:
      given: "System is running under load"
      when: "Motor runs continuously for 8+ hours"
      then: "No deadline misses occur; system remains stable and responsive"
  - id: "PERF-061"
    title: "CAN Traffic Does Not Affect Control Timing"
    rationale: "Motor control must be unaffected by communication load"
    content:
      given: "CAN bus is heavily loaded with messages"
      when: "FOC control loop is running simultaneously"
      then: "FOC timing remains within ±2 µs jitter specification"
  - id: "PERF-062"
    title: "Serial I/O Does Not Block Control Loops"
    rationale: "Serial communication should not interfere with real-time control"
    content:
      given: "User sends serial commands or monitoring data streams"
      when: "Motor control is running"
      then: "FOC loop continues with no timing degradation or missed deadlines"
  
  - id: "PERF-070"
    title: "MCU Clock Frequency Minimum 40 MHz"
    rationale: "40 MHz provides sufficient compute capacity for 10 kHz FOC loop"
    content:
      given: "System specifies microcontroller"
      when: "Clock configuration is set"
      then: "Core clock frequency is at least 40 MHz"
  - id: "PERF-071"
    title: "Recommended MCU Clock 72 MHz or Higher"
    rationale: "Higher clock provides headroom for additional features and future enhancements"
    content:
      given: "System is designed for STM32 or TM4C microcontroller"
      when: "Target clock speed is selected"
      then: "System uses 72 MHz (STM32) or 120 MHz (TM4C) for comfortable operating margin"
